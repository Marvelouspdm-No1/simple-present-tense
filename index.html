<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Present Tense Grammar Quiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f2f2f2;
            max-width: 800px;
            margin: 0 auto;
        }
        .question {
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .result {
            background: #e6ffe6;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .history {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #ddd;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        .save-buttons {
            margin-top: 20px;
            text-align: center;
        }
        .save-btn {
            background-color: #2196F3;
            margin: 5px;
        }
        .save-btn:hover {
            background-color: #0b7dda;
        }
        .whatsapp-btn {
            background-color: #25D366;
            margin: 5px;
        }
        .whatsapp-btn:hover {
            background-color: #1da851;
        }
        .download-btn {
            background-color: #FF6B35;
            margin: 5px;
        }
        .download-btn:hover {
            background-color: #E55A2B;
        }
        #reportCanvas {
            text-align: center;
        }
        .canvas-container {
            display: inline-block;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
            padding: 12px;
            border-radius: 5px;
            font-size: 16px;
            line-height: 1.4;
            border: 2px solid #e0e0e0;
            transition: all 0.2s ease;
        }
        label:hover {
            background-color: #f0f0f0;
            border-color: #4CAF50;
        }
        input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            
            .question {
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .question p {
                font-size: 18px;
                line-height: 1.5;
                margin-bottom: 15px;
            }
            
            label {
                font-size: 18px;
                padding: 15px;
                margin: 10px 0;
                min-height: 50px;
                display: flex;
                align-items: center;
            }
            
            input[type="radio"] {
                margin-right: 12px;
                transform: scale(1.5);
                flex-shrink: 0;
            }
            
            button {
                padding: 15px 25px;
                font-size: 16px;
                margin: 10px 5px;
                min-height: 50px;
            }
            
            h2 {
                font-size: 24px;
                text-align: center;
                line-height: 1.3;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin: 5px 0;
                text-align: center;
                font-size: 16px;
                padding: 15px;
            }
        }
        
        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .question p {
                font-size: 17px;
            }
            
            label {
                font-size: 17px;
                padding: 12px;
            }
            
            input[type="radio"] {
                transform: scale(1.3);
            }
        }
    </style>
</head>
<body>

<h2>Simple Present Tense Grammar Quiz - ç®€å•ç°åœ¨æ—¶è¯­æ³•æµ‹éªŒ</h2>
<div style="background: #e6f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <p><strong>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong></p>
    <p>â€¢ ğŸ–¼ï¸ <strong>ç”Ÿæˆæˆç»©å•å›¾ç‰‡</strong> - åˆ¶ä½œæ­£å¼çš„æˆç»©å•å›¾ç‰‡ï¼Œå¯ä¸‹è½½åå‘é€ç»™è€å¸ˆ</p>
    <p>â€¢ ğŸ’¾ å›¾ç‰‡æ ¼å¼çš„æˆç»©å•åŒ…å«è¯¦ç»†çš„é”™é¢˜åˆ†æï¼Œé€‚åˆå‘è€å¸ˆæ±‡æŠ¥å­¦ä¹ æƒ…å†µ</p>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab('quiz')">åšæµ‹éªŒ</div>
    <div class="tab" onclick="showTab('history')">æŸ¥çœ‹è®°å½•</div>
</div>

<div id="quiz" class="tab-content active">
    <form id="quizForm">
        <label>Name (åå­—):</label><br>
        <input type="text" id="name" required><br><br>

        <label>Form (å¹´çº§):</label><br>
        <select id="form" required>
            <option value="">Select</option>
            <option value="F1">F1</option>
            <option value="F2">F2</option>
            <option value="F3">F3</option>
            <option value="F4">F4</option>
            <option value="F5">F5</option>
        </select><br><br>

        <div id="questions"></div>

        <button type="button" onclick="submitQuiz()">æäº¤ç­”æ¡ˆ</button>
        <button type="button" onclick="saveProgress()">ä¿å­˜è¿›åº¦</button>
        <button type="button" onclick="loadProgress()">åŠ è½½è¿›åº¦</button>
    </form>

    <div id="result" class="result hidden"></div>
</div>

<div id="history" class="tab-content">
    <h3>ä½ çš„æµ‹éªŒè®°å½•</h3>
    <div id="historyList"></div>
</div>

<script>
const questions = [
    {
        q: "She ___ to school every day.",
        options: ["go", "goes", "going", "gone"],
        answer: "goes",
        explain: "ç¬¬ä¸‰äººç§°å•æ•°ä¸»è¯­'she'éœ€è¦åŠ¨è¯åŠ 's'ï¼Œ'goes'æ˜¯æ­£ç¡®çš„ã€‚",
        encourage: "ç¬¬ä¸‰äººç§°å•æ•°çš„å˜åŒ–æŒæ¡å¾—å¾ˆå¥½ï¼è®°ä½è¦åœ¨åŠ¨è¯ååŠ -så“¦~"
    },
    {
        q: "They ___ football on weekends.",
        options: ["plays", "play", "playing", "played"],
        answer: "play",
        explain: "å¤æ•°ä¸»è¯­'they'ç”¨åŠ¨è¯åŸå½¢'play'ã€‚",
        encourage: "å¤æ•°ä¸»è¯­çš„ç”¨æ³•å®Œå…¨æ­£ç¡®ï¼ä½ å·²ç»ç†è§£äº†åŸºæœ¬è§„åˆ™ï¼ŒçœŸæ£’ï¼"
    },
    {
        q: "My brother ___ TV in the evening.",
        options: ["watch", "watches", "watching", "watched"],
        answer: "watches",
        explain: "ç¬¬ä¸‰äººç§°å•æ•°'my brother'éœ€è¦åŠ¨è¯åŠ 'es'ï¼Œå› ä¸º'watch'ä»¥'ch'ç»“å°¾ã€‚",
        encourage: "ç‰¹æ®Šå˜åŒ–çš„ç¬¬ä¸‰äººç§°å•æ•°ä¹Ÿåšå¯¹äº†ï¼è¿™ä¸ªç»†èŠ‚ä½ ä¹Ÿæ³¨æ„åˆ°äº†ï¼Œè§‚å¯ŸåŠ›çœŸå¼ºï¼"
    },
    {
        q: "Water ___ at 100 degrees Celsius.",
        options: ["boil", "boils", "boiling", "boiled"],
        answer: "boils",
        explain: "è¡¨ç¤ºå®¢è§‚äº‹å®æˆ–ç§‘å­¦çœŸç†æ—¶ï¼Œå³ä½¿ä¸»è¯­æ˜¯ä¸å¯æ•°åè¯ä¹Ÿè¦ç”¨ç¬¬ä¸‰äººç§°å•æ•°å½¢å¼ã€‚",
        encourage: "ç§‘å­¦äº‹å®çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼è¿™ä¸ªé‡è¦è¯­æ³•ç‚¹ä½ å·²ç»æŒæ¡å•¦ï¼"
    },
    {
        q: "I ___ my teeth twice a day.",
        options: ["brushes", "brush", "brushing", "brushed"],
        answer: "brush",
        explain: "ç¬¬ä¸€äººç§°'I'ç”¨åŠ¨è¯åŸå½¢'brush'ã€‚",
        encourage: "ç¬¬ä¸€äººç§°çš„ç”¨æ³•å®Œå…¨æ­£ç¡®ï¼åŸºæœ¬æ¦‚å¿µä½ å·²ç»ç†è§£å¾—å¾ˆé€å½»å•¦ï¼"
    },
    {
        q: "The sun ___ in the east.",
        options: ["rise", "rises", "rising", "rose"],
        answer: "rises",
        explain: "è¡¨ç¤ºè‡ªç„¶ç°è±¡çš„å®¢è§‚äº‹å®ï¼Œä¸»è¯­'sun'æ˜¯ç¬¬ä¸‰äººç§°å•æ•°ï¼ŒåŠ¨è¯åŠ 's'ã€‚",
        encourage: "è‡ªç„¶ç°è±¡çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼ä½ çš„è¯­æ³•çŸ¥è¯†å¾ˆæ‰å®ï¼"
    },
    {
        q: "We ___ English class on Mondays.",
        options: ["has", "have", "having", "had"],
        answer: "have",
        explain: "ç¬¬ä¸€äººç§°å¤æ•°'we'ç”¨åŠ¨è¯åŸå½¢'have'ã€‚",
        encourage: "å¤æ•°ä¸»è¯­çš„ç”¨æ³•å®Œå…¨æ­£ç¡®ï¼è¿™ä¸ªåŸºæœ¬è§„åˆ™ä½ å·²ç»è®°ä½å•¦ï¼"
    },
    {
        q: "He ___ his homework after dinner.",
        options: ["do", "does", "doing", "done"],
        answer: "does",
        explain: "ç¬¬ä¸‰äººç§°å•æ•°'he'éœ€è¦åŠ¨è¯åŠ 'es'ï¼Œå› ä¸º'do'ä»¥'o'ç»“å°¾ã€‚",
        encourage: "ç‰¹æ®Šå˜åŒ–çš„ç¬¬ä¸‰äººç§°å•æ•°ä¹Ÿåšå¯¹äº†ï¼è¿™ç§ä¸è§„åˆ™å˜åŒ–ä½ ä¹Ÿè®°ä½äº†ï¼ŒçœŸå‰å®³ï¼"
    },
    {
        q: "Cats ___ mice.",
        options: ["catches", "catch", "catching", "caught"],
        answer: "catch",
        explain: "å¤æ•°ä¸»è¯­'cats'ç”¨åŠ¨è¯åŸå½¢'catch'ã€‚",
        encourage: "åŠ¨ç‰©ä¹ æ€§çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼ä½ å·²ç»æŒæ¡äº†è¡¨ç¤ºä¹ æƒ¯çš„ç”¨æ³•ï¼"
    },
    {
        q: "My mother ___ delicious cookies.",
        options: ["make", "makes", "making", "made"],
        answer: "makes",
        explain: "ç¬¬ä¸‰äººç§°å•æ•°'my mother'éœ€è¦åŠ¨è¯åŠ 's'ã€‚",
        encourage: "å®¶åº­æˆå‘˜ä½œä¸ºä¸»è¯­çš„ç”¨æ³•å®Œå…¨æ­£ç¡®ï¼æ—¥å¸¸è‹±è¯­çš„è¡¨è¿°å¾ˆå‡†ç¡®ï¼"
    },
    {
        q: "The train ___ at 8:00 every morning.",
        options: ["leave", "leaves", "leaving", "left"],
        answer: "leaves",
        explain: "è¡¨ç¤ºå›ºå®šæ—¶é—´è¡¨çš„äº‹ä»¶ï¼Œä¸»è¯­'train'æ˜¯ç¬¬ä¸‰äººç§°å•æ•°ï¼ŒåŠ¨è¯åŠ 's'ã€‚",
        encourage: "æ—¶é—´è¡¨çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼è¿™ä¸ªå®ç”¨è¯­æ³•ç‚¹ä½ å·²ç»æŒæ¡å•¦ï¼"
    },
    {
        q: "You ___ very hard for your exams.",
        options: ["works", "work", "working", "worked"],
        answer: "work",
        explain: "ç¬¬äºŒäººç§°'you'ç”¨åŠ¨è¯åŸå½¢'work'ã€‚",
        encourage: "ç¬¬äºŒäººç§°çš„ç”¨æ³•å®Œå…¨æ­£ç¡®ï¼åŸºæœ¬è¯­æ³•æ¦‚å¿µä½ å·²ç»ç†è§£å¾—å¾ˆæ¸…æ¥šï¼"
    },
    {
        q: "It ___ a lot in rainy season.",
        options: ["rain", "rains", "raining", "rained"],
        answer: "rains",
        explain: "è¡¨ç¤ºå¤©æ°”æ—¶ï¼Œç”¨'it'ä½œä¸»è¯­ï¼Œç¬¬ä¸‰äººç§°å•æ•°å½¢å¼'rains'ã€‚",
        encourage: "å¤©æ°”çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼éäººç§°ä¸»è¯­çš„ç”¨æ³•æŒæ¡å¾—å¾ˆå¥½ï¼"
    },
    {
        q: "Birds ___ south for the winter.",
        options: ["flys", "fly", "flies", "flying"],
        answer: "fly",
        explain: "å¤æ•°ä¸»è¯­'birds'ç”¨åŠ¨è¯åŸå½¢'fly'ã€‚",
        encourage: "åŠ¨ç‰©è¿å¾™çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼ä½ å·²ç»æŒæ¡äº†è¡¨ç¤ºä¹ æƒ¯æ€§åŠ¨ä½œçš„ç”¨æ³•ï¼"
    },
    {
        q: "She ___ three languages fluently.",
        options: ["speak", "speaks", "speaking", "spoken"],
        answer: "speaks",
        explain: "ç¬¬ä¸‰äººç§°å•æ•°'she'éœ€è¦åŠ¨è¯åŠ 's'ã€‚",
        encourage: "è¯­è¨€èƒ½åŠ›çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼ç¬¬ä¸‰äººç§°å•æ•°çš„å˜åŒ–ä½ å·²ç»å¾ˆç†Ÿç»ƒå•¦ï¼"
    },
    {
        q: "The Earth ___ around the Sun.",
        options: ["move", "moves", "moving", "moved"],
        answer: "moves",
        explain: "è¡¨ç¤ºç§‘å­¦äº‹å®ï¼Œä¸»è¯­'Earth'æ˜¯ç¬¬ä¸‰äººç§°å•æ•°ï¼ŒåŠ¨è¯åŠ 's'ã€‚",
        encourage: "ç§‘å­¦äº‹å®çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼è¿™ä¸ªé‡è¦è¯­æ³•ç‚¹ä½ å·²ç»æŒæ¡å•¦ï¼"
    },
    {
        q: "They ___ to music on their way to school.",
        options: ["listens", "listen", "listening", "listened"],
        answer: "listen",
        explain: "å¤æ•°ä¸»è¯­'they'ç”¨åŠ¨è¯åŸå½¢'listen'ã€‚",
        encourage: "æ—¥å¸¸ä¹ æƒ¯çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼å¤æ•°ä¸»è¯­çš„ç”¨æ³•ä½ å·²ç»å¾ˆç†Ÿæ‚‰å•¦ï¼"
    },
    {
        q: "A doctor ___ sick people.",
        options: ["help", "helps", "helping", "helped"],
        answer: "helps",
        explain: "è¡¨ç¤ºèŒä¸šçš„ä¸€èˆ¬è¡Œä¸ºï¼Œå•æ•°ä¸»è¯­'doctor'éœ€è¦åŠ¨è¯åŠ 's'ã€‚",
        encourage: "èŒä¸šè¡Œä¸ºçš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼ä½ å·²ç»æŒæ¡äº†è¡¨ç¤ºæ™®éçœŸç†çš„ç”¨æ³•ï¼"
    },
    {
        q: "We ___ our grandparents every Sunday.",
        options: ["visits", "visit", "visiting", "visited"],
        answer: "visit",
        explain: "ç¬¬ä¸€äººç§°å¤æ•°'we'ç”¨åŠ¨è¯åŸå½¢'visit'ã€‚",
        encourage: "å®¶åº­æ´»åŠ¨çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼å¤æ•°ä¸»è¯­çš„ç”¨æ³•ä½ å·²ç»æŒæ¡å¾—å¾ˆå¥½äº†ï¼"
    },
    {
        q: "He ___ to be a scientist when he grows up.",
        options: ["want", "wants", "wanting", "wanted"],
        answer: "wants",
        explain: "ç¬¬ä¸‰äººç§°å•æ•°'he'éœ€è¦åŠ¨è¯åŠ 's'ã€‚",
        encourage: "æœªæ¥æ„¿æœ›çš„è¡¨è¿°å®Œå…¨æ­£ç¡®ï¼ä½ å·²ç»æŒæ¡äº†è¡¨ç¤ºé•¿æœŸæ„¿æœ›çš„ç”¨æ³•ï¼"
    }
];

function showTab(tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Deactivate all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabId).classList.add('active');
    
    // Activate selected tab
    event.currentTarget.classList.add('active');
    
    // If history tab is selected, load history
    if (tabId === 'history') {
        loadHistory();
    }
}

function submitQuiz() {
    const name = document.getElementById('name').value;
    const form = document.getElementById('form').value;
    
    if (!name || !form) {
        alert("è¯·å¡«å†™å®Œæ•´çš„ä¸ªäººä¿¡æ¯ï¼");
        return;
    }
    
    let score = 0;
    let results = [];
    let unanswered = 0;
    
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        const isCorrect = selected && selected.value === q.answer;
        
        if (isCorrect) score++;
        if (!selected) unanswered++;
        
        results.push({
            question: q.q,
            selected: selected ? selected.value : "æœªä½œç­”",
            correct: q.answer,
            isCorrect: isCorrect,
            explain: q.explain,
            encourage: q.encourage
        });
    });
    
    // Save the attempt to history
    saveAttempt(name, form, score, results);
    
    // Display results
    displayResults(name, form, score, results, unanswered);
}

function displayResults(name, form, score, results, unanswered) {
    let output = `
        <h3>åå­—: ${name}</h3>
        <h3>å¹´çº§: ${form}</h3>
        <h3>å¾—åˆ†: <span class="${score >= 15 ? 'correct' : 'incorrect'}">${score} / 20</span></h3>
        ${unanswered > 0 ? `<p>æ³¨æ„ï¼šä½ æœ‰ ${unanswered} é¢˜æ²¡æœ‰ä½œç­”</p>` : ''}
        <p>${getFeedback(score)}</p>
        <div class="save-buttons">
            <button class="whatsapp-btn" onclick="generateReportImage('${name}', '${form}', ${score}, ${unanswered})">ğŸ–¼ï¸ ç”Ÿæˆæˆç»©å•å›¾ç‰‡</button>
        </div>
        <div id="reportCanvas" style="margin-top: 20px;"></div>
        <hr>
    `;
    
    results.forEach((r, index) => {
        output += `
            <div class="question">
                <p><strong>ç¬¬${index + 1}é¢˜ï¼š${r.isCorrect ? 'æ­£ç¡® âœ…' : 'é”™è¯¯ âŒ'}</strong></p>
                <p>é¢˜ç›®: ${r.question}</p>
                ${!r.isCorrect ? `<p>ä½ çš„ç­”æ¡ˆ: <span class="incorrect">${r.selected}</span></p>` : ''}
                <p>æ­£ç¡®ç­”æ¡ˆ: <span class="correct">${r.correct}</span></p>
                <p>è§£é‡Š: ${r.explain}</p>
                <p>é¼“åŠ±: ${r.encourage}</p>
            </div>
        `;
    });
    
    document.getElementById('result').innerHTML = output;
    document.getElementById('result').classList.remove('hidden');
    
    // Scroll to results
    document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
}

function getFeedback(score) {
    if (score === 20) {
        return "å¤ªå‰å®³å•¦ï¼å…¨å¯¹è€¶ï¼ä½ çš„ä¸€èˆ¬ç°åœ¨æ—¶ç”¨å¾—è·Ÿæ¯è¯­è€…ä¸€æ ·æ£’ï¼ğŸ‰ ç»™è‡ªå·±ç‚¹ä¸ªèµå§ï¼";
    } else if (score >= 17) {
        return "æˆç»©å¾ˆä¸é”™å“¦ï¼åªæœ‰å‡ ä¸ªå°åœ°æ–¹éœ€è¦æ³¨æ„ï¼Œä½ å·²ç»æŒæ¡å¤§éƒ¨åˆ†è¯­æ³•å•¦ï¼âœ¨";
    } else if (score >= 14) {
        return "æŒºå¥½çš„ï¼åŸºæœ¬è¯­æ³•éƒ½æŒæ¡äº†ï¼Œé”™é¢˜çœ‹çœ‹è§£é‡Šï¼Œä¸‹æ¬¡ä¼šæ›´å¥½å“’ï¼ğŸ˜Š";
    } else if (score >= 10) {
        return "æœ‰è¿›æ­¥ç©ºé—´å“¦ï¼é”™é¢˜éƒ½æ˜¯å­¦ä¹ æœºä¼šï¼Œæ…¢æ…¢æ¥ï¼Œä½ çš„è¯­æ³•ä¼šè¶Šæ¥è¶Šæ£’çš„ï¼ğŸ’ª";
    } else {
        return "ç¬¬ä¸€æ¬¡åšè¿™æ ·çš„è¯­æ³•é¢˜å§ï¼Ÿåˆ«æ‹…å¿ƒï¼æ¯ä¸ªäººéƒ½æ˜¯è¿™æ ·è¿›æ­¥çš„ï¼Œå¤šç»ƒä¹ å°±ä¼šå¥½å¾ˆå¤šå•¦ï¼ğŸŒ±";
    }
}

function generateReportImage(name, form, score, unanswered) {
    // Get current quiz results for error analysis
    let wrongAnswers = [];
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        const isCorrect = selected && selected.value === q.answer;
        if (!isCorrect) {
            wrongAnswers.push({
                number: index + 1,
                question: q.q.substring(0, 50) + "...",
                selected: selected ? selected.value : "æœªä½œç­”",
                correct: q.answer
            });
        }
    });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Calculate canvas height based on number of wrong answers
    const baseHeight = 800;
    const errorHeight = wrongAnswers.length * 30 + 100; // 30px per error + some padding
    canvas.width = 800;
    canvas.height = Math.max(baseHeight, baseHeight + errorHeight);
    
    // Background gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#f8f9fa');
    gradient.addColorStop(1, '#e9ecef');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Header background
    ctx.fillStyle = '#4CAF50';
    ctx.fillRect(0, 0, canvas.width, 120);
    
    // Title
    ctx.fillStyle = 'white';
    ctx.font = 'bold 32px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Simple Present Tense Quiz', canvas.width/2, 50);
    ctx.fillText('ç®€å•ç°åœ¨æ—¶è¯­æ³•æµ‹éªŒæˆç»©å•', canvas.width/2, 90);
    
    // Student Info Section
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('å­¦ç”Ÿä¿¡æ¯ Student Information', 50, 170);
    
    ctx.font = '20px Arial';
    ctx.fillText(`å§“å Name: ${name}`, 50, 210);
    ctx.fillText(`å¹´çº§ Form: ${form}`, 50, 240);
    ctx.fillText(`æµ‹éªŒæ—¥æœŸ Date: ${new Date().toLocaleDateString()}`, 50, 270);
    
    // Score Section
    const percentage = Math.round((score / 20) * 100);
    
    ctx.fillStyle = '#2196F3';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('æµ‹éªŒæˆç»© Test Results', 50, 320);
    
    // Score circle
    const centerX = canvas.width - 150;
    const centerY = 370;
    const radius = 80;
    
    // Draw score circle background
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fillStyle = score >= 15 ? '#4CAF50' : score >= 10 ? '#FF9800' : '#F44336';
    ctx.fill();
    
    // Score text in circle
    ctx.fillStyle = 'white';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${score}/20`, centerX, centerY - 10);
    ctx.font = 'bold 20px Arial';
    ctx.fillText(`${percentage}%`, centerX, centerY + 20);
    
    // Detailed scores
    ctx.fillStyle = '#333';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`æ€»åˆ† Total Score: ${score}/20 (${percentage}%)`, 50, 360);
    
    if (unanswered > 0) {
        ctx.fillStyle = '#F44336';
        ctx.fillText(`æœªä½œç­”é¢˜ç›® Unanswered: ${unanswered} é¢˜`, 50, 390);
    }
    
    // Performance Analysis
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    let currentY = unanswered > 0 ? 450 : 420;
    ctx.fillText('è¡¨ç°åˆ†æ Performance Analysis', 50, currentY);
    
    ctx.font = '18px Arial';
    const feedback = getFeedback(score);
    const words = feedback.split(' ');
    let line = '';
    currentY += 30;
    
    for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > 700 && n > 0) {
            ctx.fillText(line, 50, currentY);
            line = words[n] + ' ';
            currentY += 25;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, 50, currentY);
    
    // Wrong Answers Section
    if (wrongAnswers.length > 0) {
        currentY += 50;
        ctx.fillStyle = '#F44336';
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`é”™é¢˜åˆ†æ Wrong Answers (${wrongAnswers.length} é¢˜)`, 50, currentY);
        
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        
        // Show ALL wrong answers
        wrongAnswers.forEach((error, index) => {
            currentY += 30;
            ctx.fillText(`${index + 1}. ç¬¬${error.number}é¢˜: ${error.selected} â†’ ${error.correct}`, 50, currentY);
        });
    }
    
    // Footer
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('ç»§ç»­åŠ æ²¹ï¼Œå­¦å¥½è‹±è¯­è¯­æ³•ï¼Keep up the good work!', canvas.width/2, canvas.height - 30);
    
    // Display canvas and download options
    const reportDiv = document.getElementById('reportCanvas');
    reportDiv.innerHTML = `
        <div class="canvas-container">
            <h3>ğŸ“‹ æˆç»©å•å·²ç”Ÿæˆ</h3>
            <canvas id="generatedCanvas" width="800" height="${canvas.height}" style="max-width: 100%; height: auto; border: 1px solid #ddd;"></canvas>
            <div style="margin-top: 15px;">
                <button class="download-btn" onclick="downloadReportImage()">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
                <button class="whatsapp-btn" onclick="shareReportImage()">ğŸ“± å‘é€ç»™è€å¸ˆ</button>
            </div>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                ğŸ’¡ æç¤ºï¼šç‚¹å‡»"ä¸‹è½½å›¾ç‰‡"ä¿å­˜åˆ°è®¾å¤‡ï¼Œæˆ–ç‚¹å‡»"å‘é€ç»™è€å¸ˆ"ç›´æ¥é€šè¿‡WhatsAppå‘é€
            </p>
        </div>
    `;
    
    // Copy canvas content to displayed canvas
    const displayCanvas = document.getElementById('generatedCanvas');
    displayCanvas.height = canvas.height;
    const displayCtx = displayCanvas.getContext('2d');
    displayCtx.drawImage(canvas, 0, 0);
    
    // Store canvas globally for download
    window.reportCanvas = canvas;
    
    // Scroll to canvas
    reportDiv.scrollIntoView({ behavior: 'smooth' });
}

function downloadReportImage() {
    if (window.reportCanvas) {
        const link = document.createElement('a');
        link.download = `Simple_Present_Tense_æˆç»©å•_${new Date().toISOString().split('T')[0]}.png`;
        link.href = window.reportCanvas.toDataURL();
        link.click();
    }
}

function shareReportImage() {
    if (navigator.share && window.reportCanvas) {
        // Convert canvas to blob
        window.reportCanvas.toBlob(function(blob) {
            const file = new File([blob], 'Simple_Present_Tense_æˆç»©å•.png', { type: 'image/png' });
            navigator.share({
                title: 'Simple Present Tense Grammar Quiz æˆç»©å•',
                text: 'æˆ‘çš„ç®€å•ç°åœ¨æ—¶è¯­æ³•æµ‹éªŒæˆç»©å•',
                files: [file]
            }).catch(err => {
                console.log('åˆ†äº«å¤±è´¥:', err);
                // Fallback to download
                downloadReportImage();
            });
        });
    } else {
        // Fallback: open WhatsApp with instruction to teacher
        const message = encodeURIComponent('è€å¸ˆæ‚¨å¥½ï¼æˆ‘åˆšç”Ÿæˆäº†Simple Present Tenseè¯­æ³•æµ‹éªŒæˆç»©å•å›¾ç‰‡ï¼Œè¯·æŸ¥çœ‹æˆ‘å‘é€çš„å›¾ç‰‡ ğŸ“‹âœ¨');
        window.open(`https://wa.me/60127317286?text=${message}`, '_blank');
        alert('è¯·æ‰‹åŠ¨ä¸‹è½½å›¾ç‰‡ï¼Œç„¶ååœ¨WhatsAppä¸­å‘é€ç»™è€å¸ˆ ğŸ“±');
    }
}

function getGrade(score) {
    if (score >= 18) return "A+ ä¼˜ç§€";
    if (score >= 16) return "A è‰¯å¥½";
    if (score >= 14) return "B+ ä¸é”™";
    if (score >= 12) return "B åŠæ ¼";
    if (score >= 10) return "C+ éœ€è¦åŠªåŠ›";
    if (score >= 8) return "C éœ€è¦åŠ å¼º";
    return "D éœ€è¦é‡æ–°å­¦ä¹ ";
}

function getSkillLevel(score) {
    if (score >= 18) return "ä¸“å®¶çº§ ğŸŒŸ";
    if (score >= 15) return "ç†Ÿç»ƒçº§ â­";
    if (score >= 12) return "ä¸­çº§ ğŸ“š";
    if (score >= 8) return "åˆçº§ ğŸ“–";
    return "å…¥é—¨çº§ ğŸ”°";
}

function saveAttempt(name, form, score, results) {
    const attempts = JSON.parse(localStorage.getItem('simplePresentQuizAttempts') || '[]');
    const attempt = {
        date: new Date().toLocaleString(),
        name,
        form,
        score,
        results
    };
    
    attempts.unshift(attempt); // Add new attempt at beginning
    localStorage.setItem('simplePresentQuizAttempts', JSON.stringify(attempts));
}

function loadHistory() {
    const attempts = JSON.parse(localStorage.getItem('simplePresentQuizAttempts') || '[]');
    const historyList = document.getElementById('historyList');
    
    if (attempts.length === 0) {
        historyList.innerHTML = "<p>ä½ è¿˜æ²¡æœ‰ä»»ä½•æµ‹éªŒè®°å½•ï¼Œå¿«å»åšæµ‹éªŒå§ï¼</p>";
        return;
    }
    
    let html = "";
    attempts.forEach((attempt, index) => {
        html += `
            <div class="question" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">
                <h3>æµ‹éªŒ #${index + 1} - ${attempt.date}</h3>
                <p>å§“å: ${attempt.name} | å¹´çº§: ${attempt.form}</p>
                <p>å¾—åˆ†: <strong>${attempt.score} / 20</strong></p>
                <button onclick="viewAttemptDetails(${index})">æŸ¥çœ‹è¯¦æƒ…</button>
                <div style="margin-top: 10px;">
                    <button class="download-btn" onclick="generateHistoryReportImage(${index})" style="font-size: 12px; padding: 8px 12px;">ğŸ–¼ï¸ ç”Ÿæˆæˆç»©å•å›¾ç‰‡</button>
                </div>
                <div id="attemptDetails${index}" style="display: none; margin-top: 10px;">
                    ${attempt.results.map((r, qIndex) => `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${r.isCorrect ? '#e6ffe6' : '#ffe6e6'}; border-radius: 5px;">
                            <p><strong>ç¬¬${qIndex + 1}é¢˜ï¼š${r.isCorrect ? 'æ­£ç¡® âœ…' : 'é”™è¯¯ âŒ'}</strong></p>
                            <p>é¢˜ç›®: ${r.question}</p>
                            ${!r.isCorrect ? `<p>ä½ çš„ç­”æ¡ˆ: ${r.selected}</p>` : ''}
                            <p>æ­£ç¡®ç­”æ¡ˆ: ${r.correct}</p>
                            <p>è§£é‡Š: ${r.explain}</p>
                            <p>é¼“åŠ±: ${r.encourage}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    historyList.innerHTML = html;
}

function generateHistoryReportImage(attemptIndex) {
    const attempts = JSON.parse(localStorage.getItem('simplePresentQuizAttempts') || '[]');
    const attempt = attempts[attemptIndex];
    
    if (!attempt) {
        alert("æ‰¾ä¸åˆ°è¯¥æµ‹éªŒè®°å½•ï¼");
        return;
    }
    
    const unanswered = attempt.results.filter(r => r.selected === "æœªä½œç­”").length;
    const wrongAnswers = attempt.results.filter(r => !r.isCorrect).map((r, index) => ({
        number: attempt.results.indexOf(r) + 1,
        question: r.question.substring(0, 50) + "...",
        selected: r.selected,
        correct: r.correct
    }));

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Calculate canvas height based on number of wrong answers
    const baseHeight = 800;
    const errorHeight = wrongAnswers.length * 30 + 100; // 30px per error + some padding
    canvas.width = 800;
    canvas.height = Math.max(baseHeight, baseHeight + errorHeight);
    
    // Background gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#f8f9fa');
    gradient.addColorStop(1, '#e9ecef');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Header background
    ctx.fillStyle = '#4CAF50';
    ctx.fillRect(0, 0, canvas.width, 120);
    
    // Title
    ctx.fillStyle = 'white';
    ctx.font = 'bold 32px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Simple Present Tense Quiz', canvas.width/2, 50);
    ctx.fillText('ç®€å•ç°åœ¨æ—¶è¯­æ³•æµ‹éªŒæˆç»©å•', canvas.width/2, 90);
    
    // Student Info Section
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('å­¦ç”Ÿä¿¡æ¯ Student Information', 50, 170);
    
    ctx.font = '20px Arial';
    ctx.fillText(`å§“å Name: ${attempt.name}`, 50, 210);
    ctx.fillText(`å¹´çº§ Form: ${attempt.form}`, 50, 240);
    ctx.fillText(`æµ‹éªŒæ—¥æœŸ Date: ${attempt.date}`, 50, 270);
    
    // Score Section
    const percentage = Math.round((attempt.score / 20) * 100);
    
    ctx.fillStyle = '#2196F3';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('æµ‹éªŒæˆç»© Test Results', 50, 320);
    
    // Score circle
    const centerX = canvas.width - 150;
    const centerY = 370;
    const radius = 80;
    
    // Draw score circle background
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fillStyle = attempt.score >= 15 ? '#4CAF50' : attempt.score >= 10 ? '#FF9800' : '#F44336';
    ctx.fill();
    
    // Score text in circle
    ctx.fillStyle = 'white';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${attempt.score}/20`, centerX, centerY - 10);
    ctx.font = 'bold 20px Arial';
    ctx.fillText(`${percentage}%`, centerX, centerY + 20);
    
    // Detailed scores
    ctx.fillStyle = '#333';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`æ€»åˆ† Total Score: ${attempt.score}/20 (${percentage}%)`, 50, 360);
    
    if (unanswered > 0) {
        ctx.fillStyle = '#F44336';
        ctx.fillText(`æœªä½œç­”é¢˜ç›® Unanswered: ${unanswered} é¢˜`, 50, 390);
    }
    
    // Performance Analysis
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    let currentY = unanswered > 0 ? 450 : 420;
    ctx.fillText('è¡¨ç°åˆ†æ Performance Analysis', 50, currentY);
    
    ctx.font = '18px Arial';
    const feedback = getFeedback(attempt.score);
    const words = feedback.split(' ');
    let line = '';
    currentY += 30;
    
    for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > 700 && n > 0) {
            ctx.fillText(line, 50, currentY);
            line = words[n] + ' ';
            currentY += 25;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, 50, currentY);
    
    // Wrong Answers Section
    if (wrongAnswers.length > 0) {
        currentY += 50;
        ctx.fillStyle = '#F44336';
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`é”™é¢˜åˆ†æ Wrong Answers (${wrongAnswers.length} é¢˜)`, 50, currentY);
        
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        
        // Show ALL wrong answers
        wrongAnswers.forEach((error, index) => {
            currentY += 30;
            ctx.fillText(`${index + 1}. ç¬¬${error.number}é¢˜: ${error.selected} â†’ ${error.correct}`, 50, currentY);
        });
    }
    
    // Footer
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('ç»§ç»­åŠ æ²¹ï¼Œå­¦å¥½è‹±è¯­è¯­æ³•ï¼Keep up the good work!', canvas.width/2, canvas.height - 30);
    
    // Create download link
    const link = document.createElement('a');
    link.download = `Simple_Present_Tense_æˆç»©å•_${attempt.name}_${attempt.date.replace(/[/:]/g, '-')}.png`;
    link.href = canvas.toDataURL();
    link.click();
    
    // Also show success message
    alert('æˆç»©å•å›¾ç‰‡å·²ä¸‹è½½ï¼æ‚¨å¯ä»¥é€šè¿‡WhatsAppå‘é€ç»™è€å¸ˆ ğŸ“±');
}

function viewAttemptDetails(index) {
    const detailsDiv = document.getElementById(`attemptDetails${index}`);
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
}

function saveProgress() {
    const name = document.getElementById('name').value;
    const form = document.getElementById('form').value;
    
    if (!name || !form) {
        alert("è¯·å…ˆå¡«å†™ä¸ªäººä¿¡æ¯ï¼");
        return;
    }
    
    const progress = {
        name,
        form,
        answers: []
    };
    
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        progress.answers.push(selected ? selected.value : null);
    });
    
    localStorage.setItem('simplePresentQuizProgress', JSON.stringify(progress));
    alert("è¿›åº¦å·²ä¿å­˜ï¼ä½ å¯ä»¥ç¨åå›æ¥ç»§ç»­å®Œæˆæµ‹éªŒã€‚");
}

function loadProgress() {
    const progress = JSON.parse(localStorage.getItem('simplePresentQuizProgress'));
    
    if (!progress) {
        alert("æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„è¿›åº¦ï¼");
        return;
    }
    
    document.getElementById('name').value = progress.name;
    document.getElementById('form').value = progress.form;
    
    progress.answers.forEach((answer, index) => {
        if (answer) {
            const radio = document.querySelector(`input[name="q${index}"][value="${answer}"]`);
            if (radio) radio.checked = true;
        }
    });
    
    alert("è¿›åº¦å·²åŠ è½½ï¼ä½ å¯ä»¥ç»§ç»­å®Œæˆæµ‹éªŒã€‚");
}

window.onload = function() {
    const qDiv = document.getElementById('questions');
    questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = "question";
        div.innerHTML = `<p><strong>ç¬¬${index + 1}é¢˜.</strong> ${q.q}</p>` +
                        q.options.map(opt => `
                            <label><input type="radio" name="q${index}" value="${opt}"> ${opt}</label><br>
                        `).join('');
        qDiv.appendChild(div);
    });
    
    // Check if there's saved progress
    if (localStorage.getItem('simplePresentQuizProgress')) {
        if (confirm("æ£€æµ‹åˆ°æœ‰ä¿å­˜çš„è¿›åº¦ï¼Œæ˜¯å¦åŠ è½½ï¼Ÿ")) {
            loadProgress();
        }
    }
}
</script>

</body>
</html>
